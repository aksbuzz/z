<HTML>
<HEAD>
<TITLE>dd-ex: a line editor</TITLE>
</HEAD>
<BODY>
<H1>dd-ex: a line editor</H1>
<CODE>dd-ex</CODE> is a simple line editor completely written as a shell
script. Yup, you read it right - a shell script. To make things more
interesting, we use only two external commands: <CODE>dd</CODE> and
<CODE>rm</CODE>; the latter is not necessary, but it is nice to clean
up temporary files.
<P>

<H2>Table of contents</H2>
<UL>
<LI><A HREF="#why">Why did I do it?</A>
<LI><A HREF="#how">How does it work?</A>
<LI><A HREF="#usage">Usage of <CODE>dd-ex</CODE></A>
<LI><A HREF="#implementation">Implementation notes</A>
</UL>

<A NAME="why"><H2>Why did I do it?</H2></A>
I knew you would ask that. Well, some friend of mine claimed that you
can do all text editing you need using <CODE>dd</CODE> only. This is
obviously true, as you can use it to copy portions on files. You can
see <A HREF="#how">the section &quot;How?&quot;</A> for an example.
The challenge, of course, is to do this <EM>automatically</EM>. Although
we can do everything using <CODE>dd</CODE>, it is not obvious that the
Bourne shell is powerful enough for that. So I had to try and see -
and now I can say that it is possible.

<A NAME="how"><H2>How does it work?</H2></A>
Suppose that you need to replace the 5 bytes starting at position 372
in your_file with the string "hyewrfub", you can type:
<PRE>
  dd if=your_file bs=1 count=372 of=/tmp/file.beginning
  dd if=your_file bs=1 skip=377 of=/tmp/file.end
  dd of=/tmp/file.replacement bs=1 count=8 &lt;&lt;EOF
  hyewrfub
  EOF
  ( dd if=/tmp/file.beginning; dd if=/file.replacement dd if=file.end ) | \
  dd of=your_file
</PRE>

This might just need some explanation. The first line copies the initial
372 bytes of your_file to /tmp/file.beginning; the next line copies
the bytes after 377 to /tmp/file.end; finally, we copy the new string
to /tmp/file.replacement. If we just used:
<PRE>
  dd of=/tmp/file.replacement bs=1 &lt;&lt;EOF
  hyewrfub
  EOF
</PRE>
we would get an extra newline at the end of the string - we add
&quot;count=8&quot; to copy only the first 8 bytes, skipping the newline.
Finally, the last command concatenates the three temporary files
and writes the result back to your_file.
<P>

From this example it is obvious that we can do any text manipulation
if we have a way to find the appropriate byte offsets. This will be
explained in the <A HREF="#implementation">Implementation notes</A>
below.
<P>

One point to note is that, although we cannot use some common commands
line &quot;cat&quot;, we can quite easily avoid using it (see last
command in the example).
<P>

I could have used &quot;echo&quot; to insert the replacement string in
a temporary file, but it is easier to write a shell function which
emulates it using (what else?) <CODE>dd</CODE>: some implementations
use <CODE>-n</CODE> to remove the extra newline, other use <CODE>\c</CODE>,
other might even not implement &quot;echo&quot; as a shell builtin! We
don't need to worry about that - we have our own!

<A NAME="usage"><H2>Usage of <CODE>dd-ex</CODE></H2></A>

<CODE>dd-ex</CODE> maintains a notion of current file (initially none)
and of current line within the file. All text manipulation happens on
the current line. The available commands are described below, divided
by category.
<P>

<H3>Entering and leaving the editor</H3>
To enter the editor, copy <A HREF="ex">the script</A> and just run it.
There are no command line parameters.
<P>

To leave the editor, type &quot;quit&quot;

<H3>File commands</H3>
<DL>
<DT><CODE>open</CODE> file
<DD>Tries to open the file. If it succeeds, this becomes the current
    file. Otherwise it prints an error message. It cannot be used if
    there is already a current file.
<DT><CODE>new</CODE> file
<DD>Like <CODE>open</CODE>, but creates the file if needed.
<DT><CODE>close</CODE>
<DD>Forgets about the current file, if one is defined. It refuses
    to do so if there are unsaved changes
<DT><CODE>save</CODE>
<DD>Saves the current file.
<DT><CODE>save</CODE> file
<DD>Copies the current file to the one named.
<DT><CODE>name</CODE> file
<DD>Causes subsequent <CODE>save</CODE>s to behave as
    &quot;<CODE>save</CODE> file&quot;
<DT><CODE>discard</CODE>
<DD>Forgets that the current file has been modified - allows to close
    it without saving.
</DL>

<H3>Movement commands</H3>
<DL>
<DT><CODE>next</CODE>
<DD>Moves the current line down in the file. You can move to the line
    just after the end of file, but if you move after that you probably
    get an endless loop. This might or might not bother you.
<DT><CODE>prev</CODE>
<DD>Moves the current line up in the file. Unline <CODE>next</CODE>,
    it has some rudimentary checks so it doesn't try to move before the
    beginning of file.
<DT><CODE>goto</CODE> n
<DD>Moves the current line to the line numbered &quot;n&quot;. It does
    so by calling <CODE>next</CODE> or <CODE>prev</CODE> as necessary,
    so the same remarks about end of file apply.
</DL>

<H3>Text modification commands</H3>
<DL>
<DT><CODE>replace</CODE> string1 string2
<DD>Looks for &quot;string1&quot; in the current line and, if found,
    replaces it with &quot;string2&quot;. Since the two are separated
    by a space, the first one cannot contain a space (although you
    are welcome to implement quoting). The search uses shell patterns,
    so you can put a &quot;?&quot; instead of a space. Note, however,
    that you should avoid to use <CODE>*</CODE>, as the editor has
    no way to know the length of the pattern matched and will replace
    the wrong text. You are welcome to fix this and send me the patch.
<DT><CODE>nreplace</CODE> n string1 string2
<DD>Like <CODE>replace</CODE>, except that it looks for the n-th
    occurrence of &quot;string1&quot;
<DT><CODE>delete</CODE>
<DD>Throws away the current line. The next line in the file is made
    current. Not recommended on the first line after end of file,
    because of the implementation of <CODE>next</CODE>
<DT><CODE>insert</CODE> text
<DD>Inserts &quot;text;&quot; <EM>before</EM> the current line, and
    then makes the new line current. There is no need to implement an
    insert after the current line, as you are allowed to move just
    after the end of file.
</DL>

<H3>Misc commands</H3>
You could edit your file without these commands, but I personally
find them useful to figure out what's happening.

<DL>
<DT><CODE>print</CODE>
<DD>Prints the number and contents of the current line.
<DT><CODE>autoprint</CODE>
<DD>Causes the commands <CODE>open</CODE>, <CODE>new</CODE>,
    <CODE>prev</CODE>, <CODE>next</CODE>, <CODE>goto</CODE>,
    <CODE>insert</CODE>, <CODE>delete</CODE>, <CODE>replace</CODE>,
    and <CODE>insert</CODE> to print the current line after execution.
    It is equivalent to typing <CODE>print</CODE> after each such command
<DT><CODE>noprint</CODE>
<DD>Disables the autoprint feature.
</DL>

<A NAME="implementation"><H2>Implementation notes</H2></A>
The <A HREF="ex">editor</A> itself is written as a collection of shell
functions which implement useful operations. For simplicity, we have
divided the function by type here and commented each type separately.
The complete editor doesn't contain many comments, so it is not
recommended for human reading.
<P>

Note that not all the functions are actually used - this is meant as a
toolkit which you can use to create your own editor (such as, for example,
an implementation of <CODE>emacs</CODE> with complete elisp support),
so I have provided extra functions whenever it was easy to do so.

<UL>
<LI><A HREF="ex-start.html">Start of the script, setting up of variables,
    temporary files, etc.</A>
<LI><A HREF="ex-zero.html">A function to generate files of arbitrary size</A>,
    used in the arithmetic functions.
<LI><A HREF="ex-arithmetic.html">Arithmetic using <CODE>dd</CODE>!</A>, needed
    to compute line numbers, offsets, and so on
<LI><A HREF="ex-compare.html">Functions to compare numbers</A>
<LI><A HREF="ex-file.html">File functions (open, save,...)</A>
<LI><A HREF="ex-echo.html">The command <CODE>echo</CODE></A>, which we redefine
    for the reasons stated <A HREF="#how">before</A>
<LI><A HREF="ex-current.html">Functions to move the current line</A>
<LI><A HREF="ex-string.html">String manipulation functions</A>
<LI><A HREF="ex-main.html">The editor's main program</A>
</UL>

<HR>
I can't resist copying <a href="http://www.metafilter.com/67661/Words-words-words-And-symbols#1954518">this comment</a>:<BR>
<EM>Okay, so the idea of using the dd command as the fundamental primitive
operation for an editor written in shell script occurs to you. "Wow, I bet
that'd work," you think. STOP RIGHT THERE. There's no need to bring that
monster to life.</EM>

</BODY>
</HTML>
